#cloud-config
packages:
  - wget
  - vim

runcmd:
  # Slurm
  - groupadd -g 2001 slurm
  - useradd -m -c "Slurm workload manager" -d /var/lib/slurm -u 2001 -g slurm  -s /bin/bash slurm
  - groupadd -g 2002 munge
  - useradd -m -c "MUNGE Uid 'N' Gid Emporium" -d /var/lib/munge -u 2002 -g munge  -s /sbin/nologin munge
  - yum install -y munge munge-libs
  - mkdir /var/spool/slurm
  - chown slurm:slurm /var/spool/slurm
  - chown slurm:slurm /etc/slurm/slurm.conf
  - chown munge:munge /etc/munge/munge.key
  - systemctl enable munge
  - systemctl start  munge
  - yum install -y https://git.computecanada.ca/fafor10/slurm_rpms/raw/master/17.11.5/slurm-17.11.5-1.el7.centos.x86_64.rpm
  # Free IPA
  - bash /root/freeipa.sh

yum_repos:
    epel:
        baseurl: http://dl.fedoraproject.org/pub/epel/$releasever/$basearch
        enabled: true
        failovermethod: priority
        gpgcheck: false
        gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL
        name: Extra Packages for Enterprise Linux
    cvmfs:
        name: CernVM packages
        baseurl: http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs/EL/$releasever/$basearch/
        gpgkey: file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CernVM
        gpgcheck: false
        enabled: true
        protect: true

write_files:
  - content: |
        # MANAGEMENT POLICIES
        ClusterName=${cluster_name}
        ControlMachine=mgmt01
        AuthType=auth/munge
        CryptoType=crypto/munge
        SlurmUser=slurm

        # 
        SchedulerType=sched/backfill
        SelectType=select/cons_res
        SelectTypeParameters=CR_Core_Memory
        
        # NODE CONFIGURATIONS
        NodeName=node[1-${nb_nodes}] Sockets=${compute_vcpus} CoresPerSocket=1 ThreadsPerCore=1 RealMemory=${compute_ram}

        # PARTITION CONFIGURATIONS
        PartitionName=cpubase_bycore_b1 Nodes=node[1-${nb_nodes}] Default=YES

        SlurmctldPort=6817
        SlurmdPort=6818

        SlurmctldDebug=debug
        SlurmctldLogFile=/var/log/slurmctld.log
        SlurmdDebug=debug
        SlurmdLogFile=/var/log/slurmd.log

        SlurmctldPidFile=/var/run/slurmctld.pid
        SlurmdPidFile=/var/run/slurmd.pid

        MpiDefault=pmi2
        ProctrackType=proctrack/cgroup
        TaskPlugin=task/cgroup

        StateSaveLocation=/var/spool/slurm
        SallocDefaultCommand=\"srun -n1 -N1 --mem-per-cpu=0 --pty --preserve-env --mpi=none bash\"

    path: /etc/slurm/slurm.conf
  - content: |
        VkJmEF/j97xr7L33ZYsf/mZdQ527MxyvVkoBSL8H9fCjeKtrDTPJBHecsO4/iTvO
        hrOxJBh0hsLZjyl8w7V8hZISKKMyqebNL2cknn/cj7l4zbt+E3lb+RRYlfCkGHgB
        lXw86SzhFLJRjKwHTKSrhgIeFVsHXasAzakYIxJecZ7GpiwK6ViSR1hj4j06fNqC
        Wb+v3nkZGBc5HpjuxOViHr6em/z++p9b2MYGPBrZwN40ZtLtWlUWwVR/BlIiHalr
        xDC2bqMz9ubJYbAgfE/NimwsLyqQN/2kuFplBmzSNP11EZSGKFo8DM1KNFmteotG
        zanfP6uBJvgSdw3FtctsxEX06Ch6jLuGDdW6WhWJN+eH+aghEKANExdQdJtaiCr1
        HgY3xNFJzVVZcUHozWRP9GzbXdZ5SzdcQYTfZmyMcxIKRvKFLxtWTwpFfhmAPaei
        j8PlTMgZQWoVtSOpSqD3/ngUGItvs1ofqEW2eit4q+/1nKkL3M7HsorEkd2UiVN4
        g2w/m+fct72XdEp+dSRCGxNkvHpMssMg4HdgTp5EfNXRTCnWk3JOdo+0bT3L9GJc
        DnklNqvGBRVu6Fw+QBt2C7yHg+PCcJ0PNUqkuoT3k5VQibAu1w0gp/WmqG3gJhwe
        1/EXOmkL8Ml060P8nSmt6yYhzihn3s90wHMvdJQa3CnlwPFd/iw80F9cBybqjtKo
        Ck5M0nycCcprXteIOqR1ysy8KyCG6rCafk02VdW9wgY1ZthLCHdjzKrzuyzuybac
        gfa/jFpFKmmTCWsrkYcbxFx9JL1J+ZKpqHJMM9gv+4x0fn4CTnOFMgVHibmXNYqH
        lqLxR9+Sg2Ny9w2xd+13KaWii/FtmD2Pgp/P5XGPwSPT4WtzA853MeESBPqmFwlu
        6tSDtez8yQKR+zj3FzPx+EVw41VNzNt+dm6bWGz4pvS4QqUr329xygeOqJjVV4BX
        TnPuU7yPGYOKLu5cazqhKH0vV9tGKHXb+dxJ3ji/tPR85Nsr6vQ72RRqscroa3Fq
        BP11zaizzi+uf5Zf/VTyFx/04r2rbdmhU/lFFAdpmEhLfrgQzkAJHT+w+xzd1hp6
        +f9fjG15HiDM8rhkDkSZovK4c9tI+LKv3TrrH77ZG/ufvFPfm6u8iR95xRMh9kWG
        FfPW4jZl0HkQQlr8uv/gItnt4H9DZjpkOAteb/Z2y/ahPEzQkddpct5D/JjHSI40
        0J/dvVhHs9hhiSsn9PLNSRfa7psxAZNde8JrbKeU6ntI0C/GYpz8zyWillKXZ55g
        EmeBi8LpnS+OuHq9BmWqLYdmr5zcZHPlJ8XycPQE7g82h9f0LOKfe0YVeqxVo+T7
        Kraf+lA9U1nDEKob6RLYyw==
    path: /etc/munge/munge.key
    permissions: "0400"
    encoding: "base64"

disable_ec2_metadata: true