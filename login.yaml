packages:
  - ipa-client
  - libsss_autofs
  - cvmfs
  - cvmfs-config-default
  - cvmfs-auto-setup
  - nfs-utils
  - python36
  - git

runcmd:
  # NFS
  - setsebool -P use_nfs_home_dirs 1
  - mkdir -p /mnt/nfs/home
  - mkdir -p /mnt/nfs/project /project
  - mkdir -p /mnt/nfs/scratch /scratch
  - mkdir -p /mnt/nfs/etc/slurm
  - echo "mgmt01:/home      /mnt/nfs/home      nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0" >> /etc/fstab
  - echo "mgmt01:/project   /mnt/nfs/project   nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0" >> /etc/fstab
  - echo "mgmt01:/scratch   /mnt/nfs/scratch   nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0" >> /etc/fstab
  - echo "mgmt01:/etc/slurm /mnt/nfs/etc/slurm nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0" >> /etc/fstab
  - echo "/mnt/nfs/home      /home      none default,bind 0 0" >> /etc/fstab
  - echo "/mnt/nfs/project   /project   none default,bind 0 0" >> /etc/fstab
  - echo "/mnt/nfs/scratch   /scratch   none default,bind 0 0" >> /etc/fstab
  - echo "/mnt/nfs/etc/slurm /etc/slurm none default,bind 0 0" >> /etc/fstab
  - mount -a
  # CVMFS
  - rpm --import https://git.computecanada.ca/cc-cvmfs-public/cvmfs-config/raw/master/RPM-GPG-KEY-CC-CVMFS-1
  - rpm -U https://git.computecanada.ca/cc-cvmfs-public/cvmfs-config/raw/master/Packages/cvmfs-config-computecanada-latest.noarch.rpm
  - systemctl restart autofs
  # JupyterHub
  - bash /root/jupyterhub.sh

write_files:
  - path: /root/jupyterhub.sh
    content: |
        python36 -m venv /opt/jupyterhub
        source /opt/jupyterhub/bin/activate
        pip install jupyterhub
        pip install git+https://github.com/cmd-ntrf/batchspawner@remote_port_api
        pip install notebook
        # Node.js and NPM
        curl --silent --location https://rpm.nodesource.com/setup_8.x | bash -
        yum -y install nodejs
        npm install -g configurable-http-proxy
        # Ownership
        groupadd -g 2003 jupyterhub
        useradd -m -c "Jupyterhub" -d /opt/jupyterhub -u 2003 -g jupyterhub  -s /bin/bash jupyterhub
        chown -R jupyterhub:jupyterhub /opt/jupyterhub

    permissions: 0700
  - path: /opt/jupyterhub/etc/jupyterhub_config.py
    content: |
        # Configuration file for jupyterhub (postgres example).
        from batchspawner import SlurmSpawner
        class MySpawner(SlurmSpawner):
            @property
            def batch_script(self):
                with open('/opt/jupyterhub/etc/submit.sh', 'r') as script_template:
                    script = script_template.read()
                return script
        c.JupyterHub.spawner_class = MySpawner
        c.JupyterHub.hub_ip = '0.0.0.0'
        c.Spawner.http_timeout = 600
        c.Spawner.start_timeout = 600
        c.Spawner.poll_interval = 600

    permissions: 0600
  - path: /opt/jupyterhub/etc/submit.sh
    content: |
        #!/bin/bash
        #SBATCH --time=00-1:00:00
        #SBATCH --output={homedir}/jupyterhub_slurmspawner_%j.log
        #SBATCH --job-name=spawner-jupyterhub
        #SBATCH --workdir={homedir}
        #SBATCH --mem=500M
        #SBATCH --export={keepvars}
        unset XDG_RUNTIME_DIR
        module purge -f
        # Environment setup begin
        VENV="/dev/shm/$USER/jupyter"
        rm -rf $VENV
        mkdir -p $VENV
        python3.6 -m venv $VENV
        source $VENV/bin/activate
        pip install --no-cache-dir jupyterhub notebook
        pip install --no-cache-dir git+https://github.com/cmd-ntrf/batchspawner@remote_port_api 
        pip install --no-cache-dir jupyterlmod
        jupyter nbextension install --py jupyterlmod --sys-prefix
        jupyter nbextension enable --py jupyterlmod --sys-prefix
        jupyter serverextension enable --py jupyterlmod --sys-prefix
        pip install --no-cache-dir nbserverproxy
        pip install --no-cache-dir git+https://github.com/jupyterhub/nbrsessionproxy
        jupyter serverextension enable --py nbserverproxy --sys-prefix
        jupyter nbextension install --py nbrsessionproxy --sys-prefix
        jupyter nbextension enable --py nbrsessionproxy --sys-prefix
        jupyter serverextension enable --py nbrsessionproxy --sys-prefix
        deactivate
        # Environment setup end

        # Launch jupyterhub single server
        module load StdEnv
        module load python/3.6
        source $VENV/bin/activate
        {cmd}


    permissions: 0600
  - content: |
        [Unit]
        Description=Jupyterhub
        After=network-online.target

        [Service]
        User=jupyterhub
        ExecStart=/opt/jupyterhub/bin/jupyterhub 
        WorkingDirectory=/opt/jupyterhub/etc/jupyterhub

        [Install]
        WantedBy=multi-user.target
    path: /lib/systemd/system/jupyterhub.service
  - content: |
        jupyterhub      ALL=(ALL)       NOPASSWD:SETENV: /bin/sbatch, /bin/scancel [0-9]*, /bin/squeue -h -j [0-9]* -o %T\ %B
    path: /etc/sudoers.d/99-jupyterhub-user
    permissions: 0400
  - content: |
        if [[ $UID -gt 10000 ]]; then
          if [[ -r /cvmfs/soft.computecanada.ca/config/profile/bash.sh ]]; then
            source /cvmfs/soft.computecanada.ca/config/profile/bash.sh
          fi
        fi
    path: /etc/profile.d/z-00-computecanada.sh
  - path: /root/freeipa.sh
    permissions: 0700
    content: |
        #!/bin/bash
        DOMAIN=$(grep search /etc/resolv.conf | awk '{print $2}')
        hostnamectl set-hostname ${hostname}.$DOMAIN
        sed -i "/nameserver/c\nameserver ${mgmt01_ip}" /etc/resolv.conf
        until ping -c1 mgmt01 &>/dev/null; do :; done
        sleep 30
        ipa-client-install --mkhomedir --ssh-trust-dns \
                           --enable-dns-updates \
                           --unattended -p admin \
                           -w ${admin_passwd}
  - path: /etc/cvmfs/default.local
    content: |
        CVMFS_REPOSITORIES="cvmfs-config.computecanada.ca"
        CVMFS_QUOTA_LIMIT=4450
        CVMFS_HTTP_PROXY="http://mgmt01:3128"
